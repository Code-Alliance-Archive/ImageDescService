<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function handleClick(image_id){
	parent.top_bar.document.getElementById("current_image_index").value = image_id
	parent.content.location = "/daisy_book/book/content#" + image_id
}

function handleSubmitResponse(responseText, responseStatus) {
	// no need to tell the user it worked
}

function handleImageEssentialChange(form){
	jQuery.ajaxSetup({ 
		timeout: 5 * 1000,
		error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert("ERROR: Unable to save change\n" + errorThrown) }
		});
	authenticity_token = form.authenticity_token.value
	id = form["dynamic_image[id]"].value
	should_be_described = form["dynamic_image[should_be_described]"].value
	data = {
		"authenticity_token" : authenticity_token,
		"id" : id,
		"dynamic_image[should_be_described]" : should_be_described
	}
	jQuery.post("/imageDesc/dynamic_images/" + id, data, function(data, status) {handleSubmitResponse(data, status)})
}

//-->
</script>

<h3><%= @images.size %> Images</h3>
<% @images.each do | image | 
	id = image['id']
	src = image['src']
	raw_width = image['width']
	raw_height = image['height']
	ratio = 1.0 * raw_width / raw_height
	if(raw_width > raw_height)
		width = 240
		height = width / ratio
	else
		height = 160
		width = height * ratio		
	end
%>
<a id="<%= id %>" href="#<%= id %>">
<img style="border:1px solid black; padding:0.25em; font-size: 80%;" 
	 width='<%= width %>px' height='<%= height %>px' 
	onclick="handleClick('<%= id %>')"
	src='<%= src %>'>
</img>
</a>
<p>
<% 
	model = image['model'] 
	if !model
		model = DynamicImage.new
		model[:book_uid] = image['book_uid']
		model[:image_location] = image['src']
	end
%>
<%=
	form_for model do | form |
%>
		<%= form.label(:should_be_described) %>
		<%= form.select :should_be_described, [['Yes', true], ['No', false]],
			{:include_blank => true, :custom_label => 'Essential?'}, 
			{:onChange => "handleImageEssentialChange(this.form);" }  %>
		<%= form.hidden_field(:id) %>
		<%= form.hidden_field(:book_uid) %>
		<%= form.hidden_field(:book_title) %>
		<%= form.hidden_field(:image_location) %>
<!--		<%= form.submit %> -->
<%
	end
%>
</p>
<hr/>
<% end %>
