<script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function handleClick(image_id){
	parent.top_bar.document.getElementById("current_image_index").value = image_id
	parent.content.location = "/daisy_book/book/content#" + image_id
}

function handleSubmitResponse(responseText, responseStatus) {
	// no need to tell the user it worked
}

function handleImageEssentialChange(form){
	jQuery.ajaxSetup({ 
		timeout: 5 * 1000,
		error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert("ERROR: Unable to save change\n" + errorThrown) }
		});
	authenticity_token = form.authenticity_token.value
	id = form["dynamic_image[id]"].value
	should_be_described = form["dynamic_image[should_be_described]"].value
	data = {
		"authenticity_token" : authenticity_token,
		"id" : id,
		"dynamic_image[should_be_described]" : should_be_described
	}
	jQuery.post("/imageDesc/dynamic_images/" + id, data, function(data, status) {handleSubmitResponse(data, status)})
}

function shouldShow(filterValue, essentialFlagValue, descriptionCount)
{
	isEssential = essentialFlagValue.indexOf("true") >= 0
	isNonEssential = essentialFlagValue.indexOf("false") >= 0
	isUnspecified = essentialFlagValue == ""
	hasDescriptions = descriptionCount >= 1

	showEssential = (filterValue == "essential")
	if(showEssential)
		return isEssential
		
	showNonEssential = (filterValue == "non-essential")
	if(showNonEssential)
		return isNonEssential

	showNeedsDescription = (filterValue == "missing")
	if(showNeedsDescription)
		return (isEssential && !hasDescriptions)
		
	showUnspecified = (filterValue == "unspecified")
	if(showUnspecified)
		return isUnspecified
		
	return true
}

function handleFilterChange()
{
	var desired = document.getElementById("filter").value
	var flags = document.getElementsByName("should_describe");
	for (var i = 0; i < flags.length; i++) 
	{
		essential = flags[i].value
		descriptionCount = flags[i].form.description_count.value
		show = shouldShow(desired, essential, descriptionCount)
		if(show)
			flags[i].form.parentNode.style.display = "block"
		else
			flags[i].form.parentNode.style.display = "none"
	}
}

//-->
</script>
<h3>Filtering</h3>
<select id="filter" onChange="handleFilterChange()">
  <option value="">All Images</option>
  <option value="essential">Only Essential Images</option>
  <option value="non-essential">Only Non-essential Images</option>
  <option value="missing">Description needed</option>
  <option value="unspecified">Not yet specified</option>
</select>
<h3><%= @images.size %> Images</h3>
<%
    bucket = ENV['POET_ASSET_BUCKET']
	@images.each do | image |
		id = image.xml_id
		raw_src = image.image_location
		src = "book/#{raw_src}"
        s3src = "//s3.amazonaws.com/#{bucket}/#{session[:book_uid]}/#{image.image_location}"

        model =  image

		raw_width = model.width || 20
		raw_height = model.height || 20
		if(raw_height == 0)
			raw_height = 1
		end
		ratio = 1.0 * raw_width / raw_height
		if(raw_width > raw_height)
			width = 240
			height = width / ratio
		else
			height = 160
			width = height * ratio		
		end
%>
<div id="div_<%= src %>">
	<a id="<%= id %>" href="#<%= id %>">
	<img style="border:1px solid black; padding:0.25em; font-size: 80%;" 
		 width='<%= width %>px' height='<%= height %>px' 
		onclick="handleClick('<%= id %>')"
		src='<%= s3src %>'>
	</img>
	</a>
	<p>
<%=
		form_for model do | form |
%>
			<%= form.label(:should_be_described) %>
			<%= form.select :should_be_described, [['Yes', true], ['No', false]],
				{:include_blank => true, :custom_label => 'Essential?'}, 
				{:onChange => "handleImageEssentialChange(this.form);" }  %>
			<%= form.hidden_field(:id) %>
			<%= form.hidden_field(:book_uid) %>
			<%= form.hidden_field(:book_title) %>
			<%= form.hidden_field(:image_location) %>
			
			<input type='hidden' name='should_describe' 
				id='<%= "should_describe_#{model[:image_location]}" %>' 
				value='<%= model[:should_be_described] %>'
			/> 
			<input type='hidden' name='description_count' 
				id='<%= "description_count_#{model[:image_location]}" %>'
				value='<%= model.dynamic_descriptions.count %>'
			/>
			
<!--		<%= form.submit %> -->
<%
		end
%>
</p>
<hr/>
</div>
<% 
	end 
%>
